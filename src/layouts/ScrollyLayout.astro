---
import "../components/scrolly/style.css";
const { frontmatter } = Astro.props;

// 1. Determine the data source (external TS config vs inline frontmatter)
let config: any = {};
if (frontmatter.configId) {
  try {
    // Dynamically import the config file based on configId
    // Note: Vite requires literal or specific glob patterns for dynamic imports
    const allConfigs = import.meta.glob('../scrolly/data/*.ts', { eager: true });
    const configPath = `../scrolly/data/${frontmatter.configId}.ts`;
    const configMod: any = allConfigs[configPath];
    if (configMod) {
      config = configMod.config || configMod.default || {};
    }
  } catch (e) {
    console.error(`Failed to load scrolly config: ${frontmatter.configId}`, e);
  }
}

// 2. Merge logic: Frontmatter values override external config values
const page = {
  metadata: { ...(config.metadata || {}), ...(frontmatter.metadata || {}) },
  hero: { ...(config.hero || {}), ...(frontmatter.hero || {}) },
  sections: frontmatter.sections || config.sections || [],
  footerHtml: frontmatter.footerHtml || config.footerHtml || "",
  theme: { ...(config.theme || {}), ...(frontmatter.theme || {}) }
};

// Helper function for viz ID mapping
const vizMountId = (key: string) => {
  const map: Record<string, string> = {
    timeline: "chart-timeline",
    bubbles: "chart-bubbles",
    sem: "chart-sem",
    scatter: "chart-scatter",
    matrix: "chart-matrix",
    bars: "chart-bars",
    map: "chart-map",
  };
  return map[key] || `chart-${key}`;
};

const vizLegendId = (key: string) => {
  const map: Record<string, string> = { timeline: "legend-timeline" };
  return map[key];
};

const safeJson = (v: any) => JSON.stringify(v ?? null).replaceAll("</script>", "<\\/script>");
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{page.metadata.title}</title>
    <meta name="description" content={page.metadata.description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script is:inline src="https://d3js.org/d3.v7.min.js"></script>

    {/* Dynamic Theme Overrides - only rendered if theme properties exist */}
    {Object.keys(page.theme).length > 0 && (
      <style is:inline set:html={`
        :root {
          ${page.theme.accent ? `--accent-blue: ${page.theme.accent};` : ''}
          ${page.theme.paper ? `--paper: ${page.theme.paper};` : ''}
          ${page.theme.paperDark ? `--paper-dark: ${page.theme.paperDark};` : ''}
          ${page.theme.ink ? `--ink: ${page.theme.ink};` : ''}
          ${page.theme.secondary ? `--political-red: ${page.theme.secondary};` : ''}
        }
      `} />
    )}

    <script is:inline>
      (function() {
        const theme = localStorage.getItem('scrolly-theme') || 'light';
        document.body.classList.toggle('light-theme', theme === 'light');
      })();
    </script>
  </head>
  <body class="scrollytelling-theme light-theme">
    <div id="progress-bar"></div>

    <nav id="main-nav">
      <div class="nav-inner">
        <div class="nav-brand-group">
          <a href={page.metadata.homeNavUrl || "/"} class="nav-home-icon" aria-label="Back to Data">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </a>
          <span class="nav-logo">{page.metadata.brand}</span>
        </div>
        
        <div class="nav-controls-group">
          <div class="nav-sections">
            {page.sections.map((s: any) => (
              <a href={`#section-${s.id}`} class="nav-dot" data-label={s.navLabel}></a>
            ))}
          </div>
          <button id="theme-toggle" class="nav-theme-toggle" aria-label="Toggle theme">
            <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.76" y2="19.76"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.76" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.76" y2="4.22"></line>
            </svg>
            <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <section id="hero">
      <div class="hero-bg">
        <div class="hero-pattern"></div>
        <div class="hero-overlay"></div>
      </div>
      <div class="hero-content">
        <div class="hero-label">{page.hero.label}</div>
        <h1 class="hero-title">
          <Fragment set:html={page.hero.titleHtml} />
        </h1>
        <p class="hero-sub">
          <Fragment set:html={page.hero.subtitleHtml} />
        </p>
        <p class="hero-authors">
          <Fragment set:html={page.hero.authorsHtml} />
        </p>
        <p class="hero-teaser">
          <Fragment set:html={page.hero.teaserHtml} />
        </p>
        <a href={page.hero.ctaHref} class="hero-cta" aria-label="Begin Analysis">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <polyline points="19 12 12 19 5 12"></polyline>
          </svg>
        </a>
      </div>
      
      <div class="hero-stats">
        {page.hero.stats && page.hero.stats.map((stat: any) => (
          <div class="hero-stat">
            <span class="stat-num" data-target={stat.target}>0</span>
            <span class="stat-unit">{stat.unit || ""}</span>
            <div class="stat-label">{stat.label}</div>
          </div>
        ))}
      </div>
    </section>

    <div id="sidecar-wrapper">
      <div id="text-column">
        <slot />
      </div>

      <div id="viz-column">
        <div id="viz-sticky" data-storage-key={`scrolly-${page.metadata.brand.toLowerCase().replaceAll(" ", "-")}-viz-h`}>
          <div id="mobile-viz-topbar">
            <div id="mobile-tab-bar">
              <a href={page.metadata.homeNavUrl} class="mob-tab mob-home-icon" aria-label="Back to Data">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
              </a>
              {page.sections.map((s: any, i: number) => (
                <button class={`mob-tab${i === 0 ? " active" : ""}`} data-viz={`viz-${s.id}`}>{s.mobileLabel}</button>
              ))}
            </div>
            <button id="viz-toggle" aria-label="Toggle visualization">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="18 15 12 9 6 15"></polyline>
              </svg>
            </button>
          </div>

          <div id="viz-panels-container">
            {page.sections.map((s: any, i: number) => (
              <div class={`viz-panel${i === 0 ? " active" : ""}`} id={`viz-${s.id}`} data-viz-key={s.viz.key}>
            <div class="viz-title">{s.viz.title}</div>
            {s.viz.mount === "svg" ? (
              <svg data-viz-mount="svg" id={vizMountId(s.viz.key)}></svg>
            ) : (
              <div data-viz-mount="div" id={vizMountId(s.viz.key)}></div>
            )}
            <script type="application/json" data-viz-props set:html={safeJson(s.viz.props)}></script>
            {s.viz.legend ? <div class="viz-legend" data-viz-legend id={vizLegendId(s.viz.key)}></div> : null}
            {s.viz.captionHtml ? (
              <div class="viz-caption">
                <Fragment set:html={s.viz.captionHtml} />
              </div>
            ) : null}
          </div>
            ))}
          </div>

          <div id="viz-resize-handle" aria-label="Drag to resize visualization">
            <div class="viz-resize-pill"></div>
          </div>
        </div>
      </div>
    </div>

    <footer id="main-footer">
      <Fragment set:html={page.footerHtml} />
    </footer>

    <script is:inline>
      const toggle = document.getElementById('theme-toggle');
      if (toggle) {
        toggle.addEventListener('click', () => {
          const isLight = document.body.classList.toggle('light-theme');
          localStorage.setItem('scrolly-theme', isLight ? 'light' : 'dark');
        });
      }
    </script>
    <script src="../scrolly/scrolly-entry.ts"></script>
  </body>
</html>
